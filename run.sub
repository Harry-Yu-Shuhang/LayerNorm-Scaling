#!/bin/bash

#SBATCH --partition=2080ti                  
#SBATCH --nodelist=aisurrey[04,08-10]        
#SBATCH --job-name=Jacobian_Calculation          
#SBATCH --nodes=1                          
#SBATCH --ntasks=3                         
#SBATCH --gpus-per-node=4                  
#SBATCH --cpus-per-task=16                  
#SBATCH --time=20:00:00                    
#SBATCH --mem=64G                          
#SBATCH --output=output.log               
#SBATCH --error=error.log  

echo "ðŸ” ä»»åŠ¡å¼€å§‹ï¼Œå½“å‰ç›®å½•: $(pwd)" > output.log
cd $SLURM_SUBMIT_DIR || { echo "âŒ ç›®å½•ä¸å­˜åœ¨ï¼Œé€€å‡º"; exit 1; }
echo "ðŸ“Œ è¿›å…¥ç›®å½•: $SLURM_SUBMIT_DIR" >> output.log

export PYTORCH_CUDA_ALLOC_CONF="expandable_segments:True"

# âœ… ä»Ž API.json ä¸­è¯»å– WANDB_API_KEY
if [ -f "API.json" ]; then
    export WANDB_API_KEY=$(jq -r '.WANDB_API_KEY' API.json)
    echo "âœ… æˆåŠŸè¯»å– API.json ä¸­çš„ WANDB_API_KEY" >> output.log
else
    echo "âš ï¸ è­¦å‘Š: æ‰¾ä¸åˆ° API.jsonï¼ŒWandB ç™»å½•å°†å¤±è´¥" >> output.log
    export WANDB_MODE=disabled  # å¯é€‰ï¼šæ²¡æœ‰ API Key å°±ç¦ç”¨ wandb
fi

# âœ… æ£€æŸ¥ Python å’Œ GPU
echo "ðŸ”µ Python ç‰ˆæœ¬: $(python --version 2>&1)" >> output.log
echo "ðŸ” GPU ä¿¡æ¯ï¼š" >> output.log
nvidia-smi >> output.log 2>>error.log || echo "âš ï¸ GPU æ£€æµ‹å¤±è´¥" >> output.log

# âœ… è§£æž YAML é…ç½®å‚æ•°ï¼ˆæ¨¡åž‹å¤§å° / norm ç±»åž‹ / post æ•°é‡ï¼‰
yaml_file="exp_config/conf.yaml"
model_size=$(python -c "import yaml; print(yaml.safe_load(open('$yaml_file'))['experiment']['model_size'])")
norm_type=$(python -c "import yaml; print(yaml.safe_load(open('$yaml_file'))['experiment']['norm_type'])")
post_num=$(python -c "import yaml; print(yaml.safe_load(open('$yaml_file'))['experiment']['post_num'])")

echo "ðŸ“¦ YAML é…ç½®è¯»å–æˆåŠŸ: æ¨¡åž‹=$model_size, Norm=$norm_type, Post=$post_num" >> output.log

# âœ… åˆ¤æ–­å¯¹åº”çš„ .sh è„šæœ¬
sh_script="run_sh/run_${model_size}.sh"
if [[ ! -f "$sh_script" ]]; then
    echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°è„šæœ¬ $sh_script" >> output.log
    exit 1
fi

# âœ… å¯åŠ¨è®­ç»ƒä»»åŠ¡
echo "ðŸš€ å¯åŠ¨è„šæœ¬: bash $sh_script $norm_type $post_num" >> output.log
bash "$sh_script" "$norm_type" "$post_num" >> output.log 2>> error.log

echo "âœ… ä»»åŠ¡å®Œæˆ!" >> output.log
